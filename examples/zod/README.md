# Zod Validation Example

This example demonstrates **automatic client-side validation** using generated Zod schemas:

- **Server**: [go-playground/validator](https://github.com/go-playground/validator) validates requests
- **Client**: [Zod](https://zod.dev/) schemas generated from the same Go `validate` tags

Both sides enforce identical validation rules - catch errors early on the client, with server as safety net.

## Quick Start

```bash
make gen    # Generate TypeScript types, Zod schemas, and schema map
make test   # Run validation tests
make run    # Start the demo server
```

## Generated Files

The generator produces:

| File | Purpose |
|------|---------|
| `types.ts` | TypeScript interfaces |
| `schemas.zod.ts` | Zod schemas with validation rules |
| `schemas.map.ts` | Maps endpoints to their input/output schemas |
| `manifest.ts` | Service registry and metadata |

## Enabling Zod Generation

<!-- [snippet:zod-generation] -->
```go title="main.go"
_, err := tygorgen.FromApp(app).
	WithFlavor(tygorgen.FlavorZod).
	ToDir(*outDir)
```
<!-- [/snippet:zod-generation] -->

## Client-Side Validation

Import the `schemaMap` to enable automatic validation:

```typescript
import { createClient, ValidationError } from "@tygor/client";
import { registry } from "./rpc/manifest";
import { schemaMap } from "./rpc/schemas.map";

// Client with automatic input validation
const client = createClient(registry, {
  baseUrl: "http://localhost:8080",
  schemas: schemaMap, // enables validation
});

// Invalid data throws ValidationError before any network request
try {
  await client.Users.Create({
    username: "ab",  // too short (min=3)
    email: "test@example.com",
    password: "password123",
  });
} catch (e) {
  if (e instanceof ValidationError) {
    console.log(e.endpoint);   // "Users.Create"
    console.log(e.direction);  // "input"
    console.log(e.issues);     // validation issues
  }
}
```

### Validation Options

```typescript
// Input validation only (default when schemas provided)
const client = createClient(registry, {
  baseUrl: "...",
  schemas: schemaMap,
  validate: { input: true, output: false },
});

// Both input and output validation
const strictClient = createClient(registry, {
  baseUrl: "...",
  schemas: schemaMap,
  validate: { input: true, output: true },
});

// No validation (don't import schemaMap - tree-shakes away)
const rawClient = createClient(registry, { baseUrl: "..." });
```

## Generated Schema Map

<!-- [snippet-file:client/src/rpc/schemas.map.ts] -->
```typescript title="schemas.map.ts"
// Code generated by tygor. DO NOT EDIT.

import { z } from 'zod';
import * as s from './schemas.zod';

export const schemaMap = {
  "Tasks.Create": {
    input: s.CreateTaskRequestSchema,
    output: s.TaskSchema,
  },
  "Tasks.Get": {
    input: s.GetTaskParamsSchema,
    output: s.TaskSchema,
  },
  "Tasks.List": {
    input: s.ListParamsSchema,
    output: z.array(s.TaskSchema),
  },
  "Tasks.Update": {
    input: s.UpdateTaskRequestSchema,
    output: s.TaskSchema,
  },
  "Users.Create": {
    input: s.CreateUserRequestSchema,
    output: s.UserSchema,
  },
  "Users.List": {
    input: s.ListParamsSchema,
    output: z.array(s.UserSchema),
  },
} as const;

export type SchemaMap = typeof schemaMap;
```

## Go Types with Validation Tags

<!-- [snippet:create-user-request] -->
```go title="types.go"
// CreateUserRequest demonstrates request validation.
type CreateUserRequest struct {
	Username string  `json:"username" validate:"required,min=3,max=20,alphanum"`
	Email    string  `json:"email" validate:"required,email"`
	Password string  `json:"password" validate:"required,min=8,max=72"`
	Website  *string `json:"website,omitempty" validate:"omitempty,url"`
	Age      *int32  `json:"age,omitempty" validate:"omitempty,gte=13,lte=150"`
}

```
<!-- [/snippet:create-user-request] -->

## Integration Tests

<!-- [snippet:client-validation] -->
```typescript title="integration.test.ts"
/**
 * This test demonstrates automatic client-side validation:
 * 1. Client validates input before sending (using schemaMap)
 * 2. Server validates with go-playground/validator
 *
 * Both use the same validation rules from Go struct tags.
 */

let server: RunningServer;

// Client WITH validation (input validation enabled by default when schemas provided)
let validatedClient: ReturnType<typeof createClient<typeof registry.manifest>>;

// Client WITHOUT validation (for testing server-side validation)
let rawClient: ReturnType<typeof createClient<typeof registry.manifest>>;

beforeAll(async () => {
  server = await startServer({
    cwd: new URL("../../", import.meta.url).pathname,
  });

  // Create client with automatic input validation
  validatedClient = createClient(registry, {
    baseUrl: server.url,
    schemas: schemaMap,
  });

  // Create client without validation (to test server behavior)
  rawClient = createClient(registry, { baseUrl: server.url });
});

afterAll(async () => {
  await server?.stop();
});

describe("Automatic client validation", () => {
  test("client throws ValidationError for invalid input before request", async () => {
    try {
      await validatedClient.Users.Create({
        username: "ab", // too short (min=3)
        email: "test@example.com",
        password: "password123",
      });
      expect.unreachable("Should have thrown ValidationError");
    } catch (e) {
      expect(e).toBeInstanceOf(ValidationError);
      if (e instanceof ValidationError) {
        expect(e.direction).toBe("input");
        expect(e.endpoint).toBe("Users.Create");
      }
    }
  });

  test("server-side validation still works for unvalidated clients", async () => {
    // rawClient doesn't validate, so request goes to server
    try {
      await rawClient.Users.Create({
        username: "ab", // too short - server will reject
        email: "test@example.com",
        password: "password123",
      });
      expect.unreachable("Should have thrown ServerError");
    } catch (e) {
      expect(e).toBeInstanceOf(ServerError);
      if (e instanceof ServerError) {
        expect(e.code).toBe("invalid_argument");
      }
    }
  });

  test("valid data passes both client and server validation", async () => {
    const user = await validatedClient.Users.Create({
      username: "validuser",
      email: "valid@example.com",
      password: "securepass123",
    });

    expect(user.username).toBe("validuser");
    expect(user.email).toBe("valid@example.com");
  });

  test("email validation catches invalid format", async () => {
    try {
      await validatedClient.Users.Create({
        username: "testuser",
        email: "not-an-email",
        password: "password123",
      });
      expect.unreachable("Should have thrown ValidationError");
    } catch (e) {
      expect(e).toBeInstanceOf(ValidationError);
    }
  });

  test("enum validation catches invalid values", async () => {
    try {
      await validatedClient.Tasks.Create({
        title: "Test task",
        priority: "urgent" as any, // not in enum
        tags: [],
      });
      expect.unreachable("Should have thrown ValidationError");
    } catch (e) {
      expect(e).toBeInstanceOf(ValidationError);
    }
  });
});

```
<!-- [/snippet:client-validation] -->

## Schema Generation Tests

<!-- [snippet:schema-generation] -->
```typescript title="zod.test.ts"
/**
 * These tests verify that Zod schemas are correctly generated from Go
 * validation tags. The schemas can be used directly for manual validation,
 * or automatically via the client's schemaMap (see integration.test.ts).
 */

describe("Generated Zod schemas", () => {
  test("validates required fields", () => {
    const valid = CreateUserRequestSchema.safeParse({
      username: "alice123",
      email: "alice@example.com",
      password: "securepass",
    });
    expect(valid.success).toBe(true);

    const missing = CreateUserRequestSchema.safeParse({
      username: "alice123",
      // missing email and password
    });
    expect(missing.success).toBe(false);
  });

  test("validates string constraints (min/max)", () => {
    const tooShort = CreateUserRequestSchema.safeParse({
      username: "ab", // min=3
      email: "a@b.com",
      password: "12345678",
    });
    expect(tooShort.success).toBe(false);

    const tooLong = CreateUserRequestSchema.safeParse({
      username: "a".repeat(21), // max=20
      email: "a@b.com",
      password: "12345678",
    });
    expect(tooLong.success).toBe(false);
  });

  test("validates email format", () => {
    const invalid = CreateUserRequestSchema.safeParse({
      username: "alice123",
      email: "not-an-email",
      password: "securepass",
    });
    expect(invalid.success).toBe(false);
  });

  test("validates oneof/enum values", () => {
    const valid = CreateTaskRequestSchema.safeParse({
      title: "Test",
      priority: "high", // valid enum value
      tags: [],
    });
    expect(valid.success).toBe(true);

    const invalid = CreateTaskRequestSchema.safeParse({
      title: "Test",
      priority: "urgent", // not in oneof
      tags: [],
    });
    expect(invalid.success).toBe(false);
  });

  test("validates optional nullable fields", () => {
    // Optional fields can be omitted
    const withoutOptional = CreateUserRequestSchema.safeParse({
      username: "alice123",
      email: "alice@example.com",
      password: "securepass",
    });
    expect(withoutOptional.success).toBe(true);

    // Optional fields can be null
    const withNull = CreateUserRequestSchema.safeParse({
      username: "alice123",
      email: "alice@example.com",
      password: "securepass",
      website: null,
      age: null,
    });
    expect(withNull.success).toBe(true);

    // Optional fields are validated when provided
    const invalidUrl = CreateUserRequestSchema.safeParse({
      username: "alice123",
      email: "alice@example.com",
      password: "securepass",
      website: "not-a-url",
    });
    expect(invalidUrl.success).toBe(false);
  });
});

```
<!-- [/snippet:schema-generation] -->

## Supported Validators

| Go Validator | Zod Method |
|--------------|------------|
| `required` | `.min(1)` (strings) |
| `email` | `.email()` |
| `url` | `.url()` |
| `uuid` | `.uuid()` |
| `min=N` | `.min(N)` |
| `max=N` | `.max(N)` |
| `gte=N` | `.gte(N)` |
| `lte=N` | `.lte(N)` |
| `gt=N` | `.gt(N)` |
| `lt=N` | `.lt(N)` |
| `oneof=a b c` | `z.enum(["a", "b", "c"])` |
| `alphanum` | `.regex(/^[a-zA-Z0-9]+$/)` |

See [validate.go](../../tygorgen/typescript/flavor/validate.go) for the complete mapping.
