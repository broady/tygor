# Zod Validation Example

This example demonstrates **automatic client-side validation** using generated Zod schemas:

- **Server**: [go-playground/validator](https://github.com/go-playground/validator) validates requests
- **Client**: [Zod](https://zod.dev/) schemas generated from the same Go `validate` tags

Both sides enforce identical validation rules - catch errors early on the client, with server as safety net.

## Zod vs Zod-Mini

This example generates **both** flavors:

| Flavor | Import | Bundle Size | API Style |
|--------|--------|-------------|-----------|
| `zod` | `import { z } from 'zod'` | ~17kb gzipped | Method chaining |
| `zod-mini` | `import * as z from 'zod/mini'` | ~6kb gzipped | Functional composition |

Choose based on your needs:
- **Backend/SSR**: Use regular `zod` (better DX, negligible size impact)
- **Frontend bundles**: Consider `zod-mini` for smaller bundles

## Quick Start

```bash
make gen    # Generate TypeScript types, Zod schemas, and schema map
make test   # Run validation tests
make run    # Start the demo server
```

## Generated Files

The generator produces:

| File | Purpose |
|------|---------|
| `types.ts` | TypeScript interfaces |
| `schemas.zod.ts` | Zod schemas (method chaining) |
| `schemas.zod-mini.ts` | Zod-mini schemas (functional API) |
| `schemas.map.ts` | Maps endpoints to their request/response schemas |
| `manifest.ts` | Service registry and metadata |

## Enabling Zod Generation

<!-- [snippet:zod-generation] -->
```go title="main.go"
_, err := tygorgen.FromApp(app).
	WithFlavor(tygorgen.FlavorZod).
	WithFlavor(tygorgen.FlavorZodMini).
	ToDir(*outDir)
```
<!-- [/snippet:zod-generation] -->

Generate just one flavor by removing the other `WithFlavor()` call.

## Client-Side Validation

Import the `schemaMap` to enable automatic validation:

```typescript
import { createClient, ValidationError } from "@tygor/client";
import { registry } from "./rpc/manifest";
import { schemaMap } from "./rpc/schemas.map";

// Client with automatic request validation
const client = createClient(registry, {
  baseUrl: "http://localhost:8080",
  schemas: schemaMap, // enables validation
});

// Invalid data throws ValidationError before any network request
try {
  await client.Users.Create({
    username: "ab",  // too short (min=3)
    email: "test@example.com",
    password: "password123",
  });
} catch (e) {
  if (e instanceof ValidationError) {
    console.log(e.endpoint);   // "Users.Create"
    console.log(e.direction);  // "request"
    console.log(e.issues);     // validation issues
  }
}
```

### Validation Options

```typescript
// Request validation only (default when schemas provided)
const client = createClient(registry, {
  baseUrl: "...",
  schemas: schemaMap,
  validate: { request: true, response: false },
});

// Both request and response validation
const strictClient = createClient(registry, {
  baseUrl: "...",
  schemas: schemaMap,
  validate: { request: true, response: true },
});

// No validation (don't import schemaMap - tree-shakes away)
const rawClient = createClient(registry, { baseUrl: "..." });
```

## Generated Schema Map

<!-- [snippet-file:client/src/rpc/schemas.map.ts] -->
```typescript title="schemas.map.ts"
// Code generated by tygor. DO NOT EDIT.

import { z } from 'zod';
import * as s from './schemas.zod';

export const schemaMap = {
  "Tasks.Create": {
    input: s.CreateTaskRequestSchema,
    output: s.TaskSchema,
  },
  "Tasks.Get": {
    input: s.GetTaskParamsSchema,
    output: s.TaskSchema,
  },
  "Tasks.List": {
    input: s.ListParamsSchema,
    output: z.array(s.TaskSchema),
  },
  "Tasks.Update": {
    input: s.UpdateTaskRequestSchema,
    output: s.TaskSchema,
  },
  "Users.Create": {
    input: s.CreateUserRequestSchema,
    output: s.UserSchema,
  },
  "Users.List": {
    input: s.ListParamsSchema,
    output: z.array(s.UserSchema),
  },
} as const;

export type SchemaMap = typeof schemaMap;
```

## Go Types with Validation Tags

<!-- [snippet:create-user-request] -->
```go title="types.go"
// CreateUserRequest demonstrates request validation.
type CreateUserRequest struct {
	Username string  `json:"username" validate:"required,min=3,max=20,alphanum"`
	Email    string  `json:"email" validate:"required,email"`
	Password string  `json:"password" validate:"required,min=8,max=72"`
	Website  *string `json:"website,omitempty" validate:"omitempty,url"`
	Age      *int32  `json:"age,omitempty" validate:"omitempty,gte=13,lte=150"`
}

```
<!-- [/snippet:create-user-request] -->

## Supported Validators

| Go Validator | Zod | Zod-Mini |
|--------------|-----|----------|
| `required` | `.min(1)` | `.check(z.minLength(1))` |
| `email` | `.email()` | `.check(z.email())` |
| `url` | `.url()` | `.check(z.url())` |
| `min=N` (string) | `.min(N)` | `.check(z.minLength(N))` |
| `min=N` (number) | `.min(N)` | `.check(z.gte(N))` |
| `max=N` (string) | `.max(N)` | `.check(z.maxLength(N))` |
| `max=N` (number) | `.max(N)` | `.check(z.lte(N))` |
| `gte=N` | `.gte(N)` | `.check(z.gte(N))` |
| `oneof=a b c` | `z.enum([...])` | `z.enum([...])` |
| optional | `.optional()` | `z.optional(...)` |
| nullable | `.nullable()` | `z.nullable(...)` |

See [validate.go](../../tygorgen/typescript/flavor/validate.go) for the complete mapping.

## Output Comparison

**Regular Zod** (method chaining):
```ts
age: z.number().int().min(-2147483648).max(2147483647).gte(13).lte(150).nullable().optional()
```

**Zod-Mini** (functional composition):
```ts
age: z.optional(z.nullable(z.number().check(z.int(), z.gte(-2147483648), z.lte(2147483647)).check(z.gte(13), z.lte(150))))
```

Both include a trailing comment with the Go type and validation tag for debugging:
```ts
// int32 validate:"omitempty,gte=13,lte=150"
```
